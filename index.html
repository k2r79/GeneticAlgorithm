<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Genetic Algorithm</title>

    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/underscore/underscore-min.js"></script>
    <script src="js/genetic.js"></script>
    <script src="js/image-lib.js"></script>
</head>
<body>
    <canvas id="canvas" width="100" height="50"></canvas>
    <button id="live">Make it live !</button>

    <script>
        var canvas = $("#canvas")[0];
        var context = canvas.getContext("2d");
        var idealImage = new Image();

        var geneticCode = new GeneticCode(4, canvas.width / 2 * canvas.height);
        var generation = 0;

        $(document).ready(function() {
            drawIdealImage();

            drawGeneticImage();

            $('#live').click(function() {
                for (var i = 0; i < 2000; i++) {
                    geneticCode.live(drawGeneticImage);

                    generation++;

                    console.log(generation);
                }
            });

            function drawIdealImage() {
                idealImage.onload = function () {
                    context.drawImage(idealImage, 0, 0, canvas.width / 2, canvas.height);

                    setIdealImage();
                };

                idealImage.src = "images/minion.jpg";
            }

            function setIdealImage() {
                var binaryImageData = ImageLib.imageDataToBinary(context.getImageData(0, 0, canvas.width / 2, canvas.height).data);

                _.each(geneticCode.ideal.chromosomes, function(chromosome, chromosomeIndex) {
                    var binaryImageDataIndex = chromosomeIndex * 3;

                    chromosome.genes = [
                        binaryImageData[binaryImageDataIndex],
                        binaryImageData[binaryImageDataIndex + 1],
                        binaryImageData[binaryImageDataIndex + 2]
                    ];
                });
            }

            function drawGeneticImage() {
                var geneticImageData = context.createImageData(canvas.width / 2, canvas.height);

                _.each(geneticCode.fittestIndividual().chromosomes, function(chromosome, chromosomeIndex) {
                    _.each(ImageLib.imageDataToRGBA(chromosome.genes), function(pixel, pixelIndex) {
                        geneticImageData.data[chromosomeIndex * 4 + pixelIndex] = pixel;
                    });
                });

                context.putImageData(geneticImageData, canvas.width / 2, 0);
            }
        });
    </script>
</body>
</html>